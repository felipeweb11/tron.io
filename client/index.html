<html>
    <head>
        <title>tron.io</title>

        <link href="https://fonts.googleapis.com/css?family=Orbitron" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/sweetalert2/4.3.2/sweetalert2.min.css">

        <style>
            .title {
                font-family: 'Orbitron';
                font-size: 40px;
                text-align: center;
                padding: 20px 0 0 0;
                background: #fff;
            }

            .title > span {
                color: #1d70ab;
            }

            .wrapper {
                width: 1000px;
                height: 700px;
                margin: 0 auto;
                position: relative;
            }

            .game-start {
                position: absolute;
                top: 0;
                left: 50%;
                top: 50%;
                margin-left: -100px;
                margin-top: -35px;
                width: 200px;
                height: 70px;
                border: none;
                background: #ccc;
                display: block;
                cursor: pointer;
                font-size: 35px;
            }

        </style>

    </head>

    <body>

        <h1 class="title">tron.<span>io</span></h1>

        <div class="wrapper">
            <canvas id="game" width="1000" height="720"></canvas>

            <button id="startGame" class="game-start" v-on:click="startGame()">Jogar</button>

        </div>

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.26/vue.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/sweetalert2/4.3.2/sweetalert2.min.js"></script>

        <script>

            var app = new Vue({
                el: 'body',
                ready: function() {

                    this.document = $(document);
                    this.startButton = this.document.find('#startGame');
                    this.canvas = document.getElementById('game');
                    this.context = this.canvas.getContext('2d');
                    this.socket = io();

                    this.registerListeners();

                    this.drawGrid();

                },
                methods: {

                    registerListeners: function() {

                        var self = this;

                        this.socket.on('playerMove', function(data) {
                            for (var i = 0; i < data.length; i++) {
                                var player = data[i];

                                self.drawPlayer(player);
                            }
                        });

                        this.socket.on('gameOver', function(data) {

                            self.socket.emit('exit');

                            swal('Game over!', 'NÃ£o foi dessa vez :(', 'error');

                        });

                        this.socket.on('gameStarted', function() {
                            swal.close();
                        });

                    },

                    drawGrid: function() {

                        var bw = this.canvas.width;
                        var bh = this.canvas.height;
                        var p = 0;

                        this.context.beginPath();

                        this.context.fillStyle = "#283232";
                        this.context.fillRect(0, 0, bw, bh);

                        this.context.beginPath();

                        for (var x = 0; x <= bw; x += 40) {
                            this.context.moveTo(0 + x + p, p);
                            this.context.lineTo(0 + x + p, bh + p);
                        }

                        for (var x = 0; x <= bh; x += 40) {
                            this.context.moveTo(p, 0 + x + p);
                            this.context.lineTo(bw + p, 0 + x + p);
                        }

                        this.context.strokeStyle = "#515b60";
                        this.context.stroke();
                    },

                    drawPlayer: function (player) {
                        this.context.fillStyle = player.color;
                        this.context.beginPath();
                        this.context.moveTo(player.x - (player.width / 2), player.y - (player.height / 2));
                        this.context.lineTo(player.x + (player.width / 2), player.y - (player.height / 2));
                        this.context.lineTo(player.x + (player.width / 2), player.y + (player.height / 2));
                        this.context.lineTo(player.x - (player.width / 2), player.y + (player.height / 2));
                        this.context.closePath();
                        this.context.fill();
                    },

                    enableControls: function() {

                        var self = this;

                        self.document.on('keydown', function(e) {

                            switch (e.keyCode) {
                                case 39: self.socket.emit('keyPress', {inputId: 'right'}); break;
                                case 40: self.socket.emit('keyPress', {inputId: 'down'}); break;
                                case 37: self.socket.emit('keyPress', {inputId: 'left'}); break;
                                case 38: self.socket.emit('keyPress', {inputId: 'up'}); break;
                            }

                        });

                    },

                    disableControls: function() {
                        self.document.off('keydown');

                    },

                    startGame: function() {

                        this.enableControls();
                        this.startButton.hide();

                        swal({
                            title: '',
                            text: 'Aguardando outros jogadores...',
                            allowOutsideClick: false,
                            showConfirmButton: false
                        });

                        this.socket.emit('startGame', {roomType: 'two-players'});

                    }

                }
            });

        </script>

    </body>

</html>